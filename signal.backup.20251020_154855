#!/usr/bin/env bash
set -euo pipefail
cd "$(dirname "$0")"
mkdir -p logs

ts=$(date -u +%Y%m%d_%H%M%S)
run_log="logs/signal_${ts}.log"

# Запускаем оригинальный скрипт (как раньше), но:
#  - пишем полный вывод в лог запуска и в общий last_signal.log
#  - параллельно вырезаем чистый JSON в logs/last.json
./signal.core "$@" \
| tee "$run_log" \
| tee -a logs/last_signal.log \
| tee >(awk 'BEGIN{f=0} /^[[:space:]]*\{/{f=1} f{print} /^[[:space:]]*\}/{if(f){f=0; print ""}}' > logs/last.json)

echo "----------------------------------------"
echo "✅ Saved logs: $run_log"
echo "✅ Last JSON:  logs/last.json"
