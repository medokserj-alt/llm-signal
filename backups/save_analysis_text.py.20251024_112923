#!/usr/bin/env python3
import sys, re
from datetime import datetime, timezone

def main():
    data = sys.stdin.read()

    # Обрезать всё, что идёт после первого JSON-блока
    cut_idx = data.find("\n{")
    if cut_idx != -1:
        analysis = data[:cut_idx]
    else:
        m = re.search(r'(?m)^\s*\{', data)
        analysis = data[:m.start()] if m else data

    # Удалить markdown-кодфенсы (```json / ``` / ```anything)
    analysis = re.sub(r'```+\w*\s*\n?', '', analysis)

    # Точечно убрать placeholder про LESSONS
    analysis = re.sub(r'(?m)^\[LESSONS\]\s*not available\s*$', '', analysis)

    # Сжать лишние пустые строки
    analysis = re.sub(r'\n{3,}', '\n\n', analysis).strip() + "\n"

    # Сохранить
    ts = datetime.now(timezone.utc).strftime("%Y%m%d_%H%M%S")
    fname = f"analysis_{ts}.md"
    with open(fname, "w", encoding="utf-8") as f:
        f.write(analysis)
    print(f"[OK] ANALYSIS: {fname}")

if __name__ == "__main__":
    main()
