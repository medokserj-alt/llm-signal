#!/usr/bin/env python3
import sys, re
from datetime import datetime, timezone

def main():
    data = sys.stdin.read()

    # 1) Отрезаем всё, что идёт после первого JSON-блока
    cut_idx = data.find("\n{")
    if cut_idx != -1:
        analysis = data[:cut_idx]
    else:
        m = re.search(r'(?m)^\s*\{', data)
        analysis = data[:m.start()] if m else data

    # 2) Удаляем markdown-кодфенсы (```json / ``` / ```anything)
    analysis = re.sub(r'```+\w*\s*\n?', '', analysis)

    # 3) Убираем возможные хвосты повторных меток
    analysis = re.sub(r'(?m)^\s*JSON-сигнал:\s*$', '', analysis)

    # 4) ЖЁСТКО вырезаем любые блоки/следы LESSONS (и одиночную строку-плейсхолдер)
    #    - целые блоки начиная с "[LESSONS]" до ближайшего пустого ряда
    analysis = re.sub(r'(?ms)^\[LESSONS\][\s\S]*?(?:\n\s*\n|$)', '', analysis)
    #    - одиночные строки-плейсхолдеры
    analysis = re.sub(r'(?m)^\[LESSONS\]\s*not available\s*$', '', analysis)

    # 5) Сжимаем избыточные пустые строки
    analysis = re.sub(r'\n{3,}', '\n\n', analysis).strip() + "\n"

    # 6) Сохраняем с меткой времени (UTC)
    ts = datetime.now(timezone.utc).strftime("%Y%m%d_%H%M%S")
    fname = f"analysis_{ts}.md"
    with open(fname, "w", encoding="utf-8") as f:
        f.write(analysis)

    print(f"[OK] ANALYSIS: {fname}")

if __name__ == "__main__":
    main()
