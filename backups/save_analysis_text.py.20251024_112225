#!/usr/bin/env python3
import sys, re
from datetime import datetime, timezone

def main():
    data = sys.stdin.read()

    # 1) –û—Ç—Ä–µ–∑–∞–µ–º –≤—Å—ë, —á—Ç–æ –∏–¥—ë—Ç –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ JSON-–±–ª–æ–∫–∞
    cut_idx = data.find("\n{")
    if cut_idx != -1:
        analysis = data[:cut_idx]
    else:
        m = re.search(r'(?m)^\s*\{', data)
        analysis = data[:m.start()] if m else data

    # 2) –£–¥–∞–ª—è–µ–º markdown-–∫–æ–¥—Ñ–µ–Ω—Å—ã (```json / ``` / ```anything)
    analysis = re.sub(r'```+\w*\s*\n?', '', analysis)

    # 3) –£–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ö–≤–æ—Å—Ç—ã –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –º–µ—Ç–æ–∫
    analysis = re.sub(r'(?m)^\s*JSON-—Å–∏–≥–Ω–∞–ª:\s*$', '', analysis)

    # 4) –í—ã—Ä–µ–∑–∞–µ–º –ª—é–±—ã–µ –±–ª–æ–∫–∏/—Å–ª–µ–¥—ã LESSONS (–≤–∫–ª—é—á–∞—è placeholder)
    analysis = re.sub(r'(?ms)^\[LESSONS\][\s\S]*?(?:\n\s*\n|$)', '', analysis)
    analysis = re.sub(r'(?m)^\[LESSONS\]\s*not available\s*$', '', analysis)

    # 5) –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–Ø –ë–õ–û–ö–ê ¬´–°–µ—Ç–∞–ø¬ª –í –ê–ù–ê–õ–ò–ó–ï
    # 5.1 –£–±–∏—Ä–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ "2Ô∏è‚É£ –°–µ—Ç–∞–ø" (–∏ –∫–æ–≥–¥–∞ –æ–Ω —Å—Ç–æ–∏—Ç –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º)
    analysis = re.sub(r'(?m)^\s*2Ô∏è‚É£\h*–°–µ—Ç–∞–ø:?\s*$', '', analysis)
    analysis = re.sub(r'2Ô∏è‚É£\h*–°–µ—Ç–∞–ø:?\s*', '', analysis)

    # 5.2 –í—ã—Ä–µ–∑–∞–µ–º "üîÅ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤—Ö–æ–¥" (–∏ –µ—Å–ª–∏ –æ–Ω –±—ã–ª –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ)
    analysis = re.sub(r'(?m)^\s*üîÅ\s*–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤—Ö–æ–¥:.*$', '', analysis)
    analysis = re.sub(r'üîÅ\s*–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤—Ö–æ–¥:[^\n]*', '', analysis)

    # 5.3 –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ üí°/üéØ/‚òë –∫–∞–∂–¥–∞—è –Ω–∞ —Å–≤–æ–µ–π —Å—Ç—Ä–æ–∫–µ (–µ—Å–ª–∏ –º–æ–¥–µ–ª—å —Å–ª–µ–ø–∏–ª–∞ –∏—Ö –ø–æ–¥—Ä—è–¥)
    # –≤—Å—Ç–∞–≤–∏–º –ø–µ—Ä–µ–Ω–æ—Å—ã –ø–µ—Ä–µ–¥ —ç–º–æ–¥–∑–∏, –µ—Å–ª–∏ –Ω–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å–∞
    for marker in (r'üí°\s*–†–µ–∂–∏–º –≤—Ö–æ–¥–∞:', r'üéØ\s*–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:', r'‚òë\s*–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ:'):
        analysis = re.sub(rf'(?<!\n)({marker})', r'\n\1', analysis)

    # 5.4 –£–¥–∞–ª–∏–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –≤ –∫–æ–Ω—Ü–µ —Å—Ç—Ä–æ–∫
    analysis = re.sub(r'[ \t]+\n', '\n', analysis)

    # 6) –°–∂–∏–º–∞–µ–º –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
    analysis = re.sub(r'\n{3,}', '\n\n', analysis).strip() + "\n"

    # 7) –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å –º–µ—Ç–∫–æ–π –≤—Ä–µ–º–µ–Ω–∏ (UTC)
    ts = datetime.now(timezone.utc).strftime("%Y%m%d_%H%M%S")
    fname = f"analysis_{ts}.md"
    with open(fname, "w", encoding="utf-8") as f:
        f.write(analysis)

    print(f"[OK] ANALYSIS: {fname}")

if __name__ == "__main__":
    main()
